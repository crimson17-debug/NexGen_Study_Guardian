<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Branch Channels | NexGen</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* --- THEME VARIABLES --- */
:root {
    --primary: #3b82f6;
    --primary-glow: rgba(59, 130, 246, 0.4);
    --bg-body: #f8fafc;
    --bg-sidebar: rgba(255, 255, 255, 0.85);
    --bg-card: #ffffff;
    --bg-hover: #f1f5f9;
    --bg-input: rgba(255, 255, 255, 0.5);
    --border: #e2e8f0;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    --glass-blur: blur(12px);
    --success: #10b981;
}

[data-theme="dark"] {
    --primary: #818cf8;
    --primary-glow: rgba(129, 140, 248, 0.3);
    --bg-body: linear-gradient(135deg, #020617 0%, #1e1b4b 50%, #172554 100%);
    --bg-sidebar: rgba(15, 23, 42, 0.6);
    --bg-card: rgba(30, 41, 59, 0.7);
    --bg-hover: rgba(51, 65, 85, 0.8);
    --bg-input: rgba(15, 23, 42, 0.6);
    --border: rgba(255, 255, 255, 0.08);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --glass-blur: blur(20px); 
}

/* --- TYPING INDICATOR (Moved up for priority) --- */
.typing-indicator { 
    display: flex; gap: 4px; padding: 12px 16px; 
    align-self: flex-start; background: var(--bg-hover); 
    border-radius: 18px; border: 1px solid var(--border); 
    width: fit-content; margin-bottom: 10px;
}
.dot { 
    width: 6px; height: 6px; background: var(--text-muted); 
    border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; 
}
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce { 
    0%, 80%, 100% { transform: scale(0); } 
    40% { transform: scale(1); } 
}

/* --- RESET & BASE --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: background 0.4s ease, color 0.2s ease, border-color 0.3s ease; }
body { height: 100vh; display: flex; background: var(--bg-body); background-size: 200% 200%; color: var(--text-main); overflow: hidden; }

/* --- SIDEBAR --- */
.sidebar { width: 270px; background: var(--bg-sidebar); backdrop-filter: var(--glass-blur); border-right: 1px solid var(--border); padding: 24px 16px; display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; overflow-y: auto; }
.sidebar::-webkit-scrollbar { width: 5px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.logo-container { display: flex; align-items: center; gap: 12px; padding: 0 12px 20px; }
.logo-icon { width: 34px; height: 34px; background: linear-gradient(135deg, var(--primary), #4f46e5); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px var(--primary-glow); overflow: hidden; }
.logo-img { width: 100%; height: 100%; object-fit: cover; }
.logo-text { font-size: 1.3rem; font-weight: 700; color: var(--text-main); }
.sidebar-divider { height: 1px; background: var(--border); margin: 8px 8px 20px; }
.section-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; margin: 20px 12px 10px; }

.nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; color: var(--text-muted); text-decoration: none; font-size: 0.95rem; font-weight: 500; margin-bottom: 4px; cursor: pointer; position: relative; overflow: hidden; z-index: 1; }
.nav-item::before { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: var(--bg-hover); z-index: -1; border-radius: 12px; transform: scaleX(0); transform-origin: left; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
.nav-item.active { color: var(--primary); font-weight: 600; }
.nav-item.active::before { transform: scaleX(1); background: var(--bg-hover); opacity: 0.5; }
.nav-item.active i { color: var(--primary); }
.nav-item:hover { color: var(--text-main); transform: translateX(6px); }
.nav-item:hover::before { transform: scaleX(1); }
.nav-item i { width: 24px; text-align: center; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
.nav-item:hover i { transform: scale(1.15) rotate(5deg); color: var(--primary); }

/* --- HEADER --- */
.main-layout { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
.top-bar { height: 72px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; background: var(--bg-sidebar); backdrop-filter: var(--glass-blur); border-bottom: 1px solid var(--border); z-index: 10; }
.search-wrapper { position: relative; width: 400px; }
.search-input { width: 100%; padding: 11px 16px 11px 44px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); font-size: 0.9rem; }
.search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); background: var(--bg-card); }
.search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.header-actions { display: flex; align-items: center; gap: 16px; }
.action-btn { width: 42px; height: 42px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
.action-btn:hover { background: var(--bg-hover); color: var(--text-main); border-color: var(--primary); transform: translateY(-2px); }
.profile-avatar { width: 42px; height: 42px; border-radius: 12px; background: linear-gradient(135deg, #6366f1, #d946ef); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; cursor: pointer; }

/* Hamburger Menu Button (Hidden on Desktop) */
.mobile-menu-btn { display: none; margin-right: 15px; background: transparent; border: none; font-size: 1.4rem; color: var(--text-muted); cursor: pointer; }

/* --- CHANNEL LAYOUT --- */
.channel-container {
    flex: 1;
    display: flex;
    overflow: hidden;
    background: var(--bg-body);
}

/* 1. Left Sidebar: Channels List */
.channel-sidebar {
    width: 260px;
    background: var(--bg-hover);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    padding: 20px;
    transition: width 0.3s ease;
    flex-shrink: 0;
    overflow: hidden; /* Changed from auto to hidden to use internal scroll area */
}

/* Sidebar Scroll Area Container */
.sidebar-scroll-area {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    padding-right: 5px; /* Prevent scrollbar overlap */
    /* Firefox */
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
}

/* Custom Scrollbar for Sidebar Area */
.sidebar-scroll-area::-webkit-scrollbar { width: 5px; }
.sidebar-scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
.sidebar-scroll-area::-webkit-scrollbar-track { background: transparent; }

.branch-select-wrapper { margin-bottom: 20px; position: relative; flex-shrink: 0; }
.branch-select {
    width: 100%; padding: 12px; border-radius: 12px;
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text-main); font-weight: 600; cursor: pointer; appearance: none;
    outline: none;
}
.branch-select-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }

.channel-group-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin: 15px 0 8px 5px; letter-spacing: 0.05em; }

.channel-item {
    padding: 10px 12px; border-radius: 8px;
    color: var(--text-muted); font-weight: 500; font-size: 0.95rem;
    cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: all 0.2s;
    white-space: nowrap; overflow: hidden;
}
.channel-item:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
.channel-item.active { background: var(--bg-card); color: var(--primary); font-weight: 600; box-shadow: var(--shadow); }
.channel-hash { color: var(--text-muted); opacity: 0.6; font-size: 1.1rem; flex-shrink: 0; }
.channel-text { overflow: hidden; text-overflow: ellipsis; }

/* Branch Item Specifics */
.branch-item { border: 1px solid transparent; }
.branch-item.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }

.create-group-btn {
    margin-top: auto;
    width: 100%; padding: 12px;
    border: 1px dashed var(--primary); background: rgba(59, 130, 246, 0.05);
    color: var(--primary); border-radius: 10px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.2s; white-space: nowrap; overflow: hidden;
    flex-shrink: 0; /* Ensures it stays fixed size */
}
.create-group-btn:hover { background: var(--primary); color: white; }

/* 2. Middle: Main Chat Area */
.chat-area {
    flex: 1;
    display: flex; flex-direction: column;
    background: var(--bg-card);
    position: relative;
    min-width: 0; 
}

.chat-area-header {
    height: 70px; padding: 0 25px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
}
.chat-title h3 { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.chat-desc { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }

.messages-feed {
    flex: 1; overflow-y: auto; padding: 25px;
    display: flex; flex-direction: column; gap: 20px;
}

.message-group { display: flex; gap: 15px; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

.user-avatar { 
    width: 40px; height: 40px; border-radius: 12px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; color: white; font-size: 0.9rem;
}
.msg-content { flex: 1; min-width: 0; }
.msg-header { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; }
.username { font-weight: 600; color: var(--text-main); }
.timestamp { font-size: 0.75rem; color: var(--text-muted); }
.msg-text { line-height: 1.5; color: var(--text-muted); font-size: 0.95rem; white-space: pre-wrap; word-break: break-word; }

/* Locked Screen Style */
.locked-view {
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    height: 100%; color: var(--text-muted); text-align: center;
    padding: 20px;
    animation: fadeIn 0.4s ease;
}
.locked-icon { font-size: 4rem; margin-bottom: 20px; color: #ef4444; opacity: 0.8; }
.locked-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
.locked-btn { margin-top: 20px; padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
.locked-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--primary-glow); }

/* Attachment Styling */
.attachment-preview {
    display: inline-flex; align-items: center; gap: 10px;
    background: var(--bg-hover); border: 1px solid var(--border);
    padding: 10px 15px; border-radius: 8px; margin-top: 8px;
    cursor: pointer; transition: background 0.2s;
}
.attachment-preview:hover { background: var(--bg-input); border-color: var(--primary); }
.attachment-icon { color: var(--primary); font-size: 1.2rem; }
.attachment-name { font-weight: 500; color: var(--text-main); font-size: 0.9rem; }

.chat-input-area {
    padding: 20px 25px;
    border-top: 1px solid var(--border);
    background: var(--bg-card);
}
.input-wrapper {
    background: var(--bg-hover); border-radius: 12px;
    display: flex; align-items: center; padding: 5px;
    border: 1px solid var(--border);
}
.input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
.chat-btn { width: 40px; height: 40px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; border-radius: 8px; flex-shrink: 0; }
.chat-btn:hover { color: var(--text-main); background: rgba(0,0,0,0.05); }
.chat-field { flex: 1; background: transparent; border: none; padding: 10px; font-size: 0.95rem; color: var(--text-main); outline: none; min-width: 0; }
.send-msg-btn { background: var(--primary); color: white; margin-left: 5px; }
.send-msg-btn:hover { background: #2563eb; color: white; }

/* 3. Right: Info Panel */
.info-panel {
    width: 280px;
    background: var(--bg-hover);
    border-left: 1px solid var(--border);
    padding: 20px;
    overflow-y: auto;
    display: flex; flex-direction: column; gap: 25px;
    flex-shrink: 0;
}
.info-section h4 { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em; }

.pinned-item {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px; margin-bottom: 10px;
    font-size: 0.9rem; cursor: pointer; transition: transform 0.2s;
}
.pinned-item:hover { transform: translateX(3px); border-color: var(--primary); }
.pin-header { display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 4px; color: var(--primary); font-size: 0.8rem; }

.user-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 0.9rem; font-weight: 500; cursor: pointer; padding: 5px; border-radius: 8px; transition: background 0.2s; }
.user-list-item:hover { background: var(--bg-card); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; border: 2px solid var(--bg-hover); position: absolute; bottom: -2px; right: -2px; }
.avatar-wrapper { position: relative; width: 32px; height: 32px; }
.avatar-img { width: 100%; height: 100%; border-radius: 8px; object-fit: cover; }

/* --- MODAL STYLES (Create Group) --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: none; align-items: center; justify-content: center; z-index: 2000;
}
.modal-content {
    background: var(--bg-card); padding: 30px; border-radius: 20px;
    width: 420px; border: 1px solid var(--border); box-shadow: var(--shadow);
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.form-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
.form-input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; color: var(--text-main); outline: none; margin-bottom: 15px; }
.form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }

.icon-selector { display: flex; gap: 10px; margin-bottom: 20px; }
.icon-option { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-hover); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
.icon-option.selected { border-color: var(--primary); background: var(--primary-glow); }

.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.btn-cancel { background: transparent; border: 1px solid var(--border); padding: 10px 20px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 600; }
.btn-create { background: var(--primary); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: white; font-weight: 600; }

/* AI WIDGET STYLES */
.ai-widget { position: absolute; bottom: 30px; right: 30px; z-index: 999; }
.ai-minimized { background: var(--bg-card); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 50px; padding: 12px 24px; box-shadow: var(--shadow); color: var(--text-main); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: transform 0.3s; }
.ai-minimized:hover { transform: translateY(-3px) scale(1.02); }
.widget-status { width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981; }
.chat-interface { position: absolute; bottom: 0; right: 0; width: 380px; height: 550px; background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); transition: all 0.4s; }
.ai-widget.expanded .chat-interface { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }
.ai-widget.expanded .ai-minimized { opacity: 0; pointer-events: none; display: none; }
.chat-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.05); }
.ai-profile { display: flex; align-items: center; gap: 10px; font-weight: 600; }
.ai-avatar-small { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; }
.close-chat { background: none; border: none; color: var(--text-muted); cursor: pointer; }
.chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
.msg { padding: 12px 16px; font-size: 0.9rem; line-height: 1.5; max-width: 85%; border-radius: 12px; }
.msg-user { align-self: flex-end; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border-radius: 18px 18px 0 18px; }
.msg-ai { align-self: flex-start; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-main); border-radius: 18px 18px 18px 0; }
.chat-footer { padding: 16px; }
.chat-input-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 50px; padding: 6px 6px 6px 16px; display: flex; align-items: center; }
.chat-input { flex: 1; border: none; background: transparent; outline: none; color: var(--text-main); }
.send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; }

/* Mobile Responsive Adjustments */
@media (max-width: 1024px) {
    /* Reveal Main Sidebar on Button Click */
    .sidebar { position: fixed; transform: translateX(-100%); transition: transform 0.3s; z-index: 30; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.open { transform: translateX(0); }
    
    .mobile-menu-btn { display: block; }
    .search-wrapper { max-width: 200px; }
    
    .info-panel { display: none; } 
}

/* Stricter mobile styles for very small screens */
@media (max-width: 768px) {
    /* Compact Channel Sidebar */
    .channel-sidebar { width: 70px; padding: 10px; } 
    .channel-group-label, .branch-select-icon, .create-group-btn span { display: none; }
    .channel-item .channel-text { display: none; }
    .channel-item { justify-content: center; padding: 10px 0; }
    .channel-hash { margin: 0; font-size: 1.3rem; opacity: 1; }
    .create-group-btn { padding: 10px 0; }
    .create-group-btn i { margin: 0; }
    
    .chat-area-header { padding: 0 15px; }
}
</style>
</head>
<body>

<div class="sidebar" id="mainSidebar">
    <div class="logo-container">
        <div class="logo-icon"><img src="NexGen-logo.jpg" alt="NexGen Logo" class="logo-img"></div>
        <span class="logo-text">NexGen</span>
    </div>
    <div class="sidebar-divider"></div>
    <a href="dashboard.html" class="nav-item"><i class="fa-solid fa-house-chimney"></i>Dashboard</a>
    <div class="section-label">Academics</div>
    <a href="aipapergen.html" class="nav-item"><i class="fa-solid fa-wand-magic-sparkles"></i>AI Paper Gen</a>
    <a href="syllabus.html" class="nav-item"><i class="fa-solid fa-crosshairs"></i>Syllabus Tracker</a>
    <div class="section-label">Community</div>
    <a href="notes.html" class="nav-item"><i class="fa-solid fa-brain"></i>Notes Repo</a>
    <a href="#" class="nav-item active"><i class="fa-solid fa-code-branch"></i>Branch Channel</a>
    <div class="section-label">Tools</div>
    <a href="editor.html" class="nav-item"><i class="fa-solid fa-terminal"></i>Code Editor</a>
    <div class="section-label">Database</div>
    <a href="archive.html" class="nav-item"><i class="fa-solid fa-database"></i>PYQ Archive</a>
    <a href="syllabus-list.html" class="nav-item"><i class="fa-solid fa-list-check"></i>Syllabus List</a>
    <a href="notes.html" class="nav-item"><i class="fa-solid fa-folder-open"></i>Notes Library</a>
</div>

<div class="main-layout">
    
    <div class="top-bar">
        <div style="display: flex; align-items: center;">
            <button class="mobile-menu-btn" onclick="toggleMainSidebar()"><i class="fa-solid fa-bars"></i></button>
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" placeholder="Search messages...">
            </div>
        </div>
        <div class="header-actions">
            <button class="action-btn" id="theme-toggle"><i class="fa-solid fa-moon"></i></button>
            <button class="action-btn"><i class="fa-regular fa-bell"></i></button>
            <div class="profile-avatar">JD</div>
        </div>
    </div>

    <div class="channel-container">
        
        <!-- 1. LEFT: CHANNEL LIST -->
        <div class="channel-sidebar">
            <div class="branch-select-wrapper">
                <select class="branch-select" id="branchSelector" onchange="switchBranch()">
                    <option value="" disabled selected>Select Domain</option>
                    
                    <optgroup label="Open Domains">
                        <option value="General">General Sciences</option>
                        <option value="DS">Data Science & Stats</option>
                        <option value="AI">Artificial Intelligence</option>
                        <option value="Humanities">Humanities</option>
                    </optgroup>

                    <optgroup label="Engineering (Special Permission)">
                        <option value="CSE">Computer Science</option>
                        <option value="ECE">Electronics (ECE)</option>
                        <option value="MECH">Mechanical (MECH)</option>
                        <option value="CIVIL">Civil Engineering</option>
                    </optgroup>
                </select>
                <i class="fa-solid fa-chevron-down branch-select-icon"></i>
            </div>

            <!-- Scrollable Middle Section -->
            <div class="sidebar-scroll-area">
                <div class="channel-group-label" style="margin-top: 0;">Engineering Branches <i class="fa-solid fa-lock" style="font-size:0.7em; margin-left:5px;"></i></div>
                <div class="channel-list" id="branchList">
                    <div class="channel-item branch-item active" onclick="selectBranch(this, 'CSE')">
                        <span class="channel-hash"><i class="fa-solid fa-building-columns"></i></span> <span class="channel-text">CSE</span>
                    </div>
                    <div class="channel-item branch-item" onclick="selectBranch(this, 'ECE')">
                        <span class="channel-hash"><i class="fa-solid fa-microchip"></i></span> <span class="channel-text">ECE</span>
                    </div>
                    <div class="channel-item branch-item" onclick="selectBranch(this, 'MECH')">
                        <span class="channel-hash"><i class="fa-solid fa-gears"></i></span> <span class="channel-text">MECH</span>
                    </div>
                    <div class="channel-item branch-item" onclick="selectBranch(this, 'CIVIL')">
                        <span class="channel-hash"><i class="fa-solid fa-building"></i></span> <span class="channel-text">CIVIL</span>
                    </div>
                    <div class="channel-item branch-item" onclick="selectBranch(this, 'DS')">
                        <span class="channel-hash"><i class="fa-solid fa-database"></i></span> <span class="channel-text">Data Science</span>
                    </div>
                </div>

                <div class="channel-group-label">Text Channels</div>
                <div class="channel-list" id="channelList">
                    <div class="channel-item active" onclick="selectChannel(this, 'general')">
                        <span class="channel-hash">#</span> <span class="channel-text">general</span>
                    </div>
                    <div class="channel-item" onclick="selectChannel(this, 'resources')">
                        <span class="channel-hash">#</span> <span class="channel-text">resources</span>
                    </div>
                    <div class="channel-item" onclick="selectChannel(this, 'doubts-discussion')">
                        <span class="channel-hash">#</span> <span class="channel-text">doubts-discussion</span>
                    </div>
                    <div class="channel-item" onclick="selectChannel(this, 'events-news')">
                        <span class="channel-hash">#</span> <span class="channel-text">events-news</span>
                    </div>
                </div>

                <div class="channel-group-label" style="margin-top:20px;">Study Groups</div>
                <div class="channel-list" id="groupList">
                    <div class="channel-item" onclick="selectChannel(this, 'Project Alpha', true)">
                        <i class="fa-solid fa-lock channel-hash" style="font-size:0.8rem;"></i> <span class="channel-text">Project Alpha</span>
                    </div>
                    <div class="channel-item" onclick="selectChannel(this, 'Hackathon Team', true)">
                        <i class="fa-solid fa-lock channel-hash" style="font-size:0.8rem;"></i> <span class="channel-text">Hackathon Team</span>
                    </div>
                </div>
            </div>

            <button class="create-group-btn" onclick="openCreateModal()">
                <i class="fa-solid fa-plus"></i> <span class="channel-text">Create Group</span>
            </button>
        </div>

        <!-- 2. MIDDLE: CHAT FEED -->
        <div class="chat-area">
            <div class="chat-area-header">
                <div class="chat-title">
                    <span id="channelIconWrapper"><span style="color:var(--text-muted); font-size:1.5rem;">#</span></span> 
                    <h3><span id="currentChannelName">general</span></h3>
                    <div class="chat-desc" style="margin-left: 10px;">General discussion for <span id="currentBranchName">CSE</span> students.</div>
                </div>
                <div class="header-actions">
                    <button class="action-btn" style="border:none;"><i class="fa-solid fa-phone"></i></button>
                    <button class="action-btn" style="border:none;"><i class="fa-solid fa-video"></i></button>
                    <button class="action-btn" style="border:none;"><i class="fa-solid fa-user-group"></i></button>
                </div>
            </div>

            <div class="messages-feed" id="mainChatFeed">
                <!-- Initial Messages -->
                <div class="message-group">
                    <div class="user-avatar" style="background:#ef4444;">AM</div>
                    <div class="msg-content">
                        <div class="msg-header"><span class="username">Alex Martin</span> <span class="timestamp">Today at 10:30 AM</span></div>
                        <div class="msg-text">Has anyone started the assignment for Database Management yet? The deadline is next Monday.</div>
                    </div>
                </div>
                
                <div class="message-group">
                    <div class="user-avatar" style="background:#3b82f6;">SJ</div>
                    <div class="msg-content">
                        <div class="msg-header"><span class="username">Sarah Jenkins</span> <span class="timestamp">Today at 10:32 AM</span></div>
                        <div class="msg-text">Yeah, I'm halfway through. The normalization part is a bit tricky. I can share some notes in #resources if you want?</div>
                        <!-- Mock Attachment -->
                        <div class="attachment-preview" onclick="viewAttachment('Normalization_Notes.pdf')">
                            <i class="fa-solid fa-file-pdf attachment-icon"></i>
                            <span class="attachment-name">Normalization_Notes.pdf</span>
                        </div>
                    </div>
                </div>

                <div class="message-group">
                    <div class="user-avatar" style="background:#10b981;">RK</div>
                    <div class="msg-content">
                        <div class="msg-header"><span class="username">Rahul Kumar</span> <span class="timestamp">Today at 10:35 AM</span></div>
                        <div class="msg-text">That would be super helpful, Sarah! Thanks. Also, is there a class tomorrow?</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area" id="chatInputArea">
                <div class="input-wrapper">
                    <button class="chat-btn"><i class="fa-solid fa-circle-plus"></i></button>
                    <input type="text" class="chat-field" id="mainChatInput" placeholder="Message #general..." onkeypress="handleMainEnter(event)">
                    <button class="chat-btn"><i class="fa-solid fa-face-smile"></i></button>
                    <button class="chat-btn send-msg-btn" onclick="sendMainMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- 3. RIGHT: INFO PANEL -->
        <div class="info-panel">
            <div class="info-section">
                <h4><i class="fa-solid fa-thumbtack"></i> Pinned</h4>
                <div class="pinned-item" onclick="viewAttachment('Exam_Schedule.pdf')">
                    <div class="pin-header"><i class="fa-solid fa-file-pdf"></i> Exam Schedule.pdf</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Shared by Admin</div>
                </div>
                <div class="pinned-item" onclick="viewAttachment('Syllabus_Link.html')">
                    <div class="pin-header"><i class="fa-solid fa-link"></i> Syllabus Link</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Official University Site</div>
                </div>
            </div>

            <div class="info-section">
                <h4>Online â€” 3</h4>
                <div class="user-list-item" onclick="openDM('Alex Martin')">
                    <div class="avatar-wrapper">
                        <div class="avatar-img" style="background:#ef4444; display:flex; align-items:center; justify-content:center; color:white; font-weight:700;">AM</div>
                        <div class="status-dot" style="background:#10b981;"></div>
                    </div>
                    <span>Alex Martin</span>
                </div>
                <div class="user-list-item" onclick="openDM('Sarah Jenkins')">
                    <div class="avatar-wrapper">
                        <div class="avatar-img" style="background:#3b82f6; display:flex; align-items:center; justify-content:center; color:white; font-weight:700;">SJ</div>
                        <div class="status-dot" style="background:#eab308;"></div>
                    </div>
                    <span>Sarah Jenkins</span>
                </div>
                <div class="user-list-item" onclick="openDM('John Doe')">
                    <div class="avatar-wrapper">
                        <div class="avatar-img" style="background:#8b5cf6; display:flex; align-items:center; justify-content:center; color:white; font-weight:700;">JD</div>
                        <div class="status-dot" style="background:#10b981;"></div>
                    </div>
                    <span>John Doe (You)</span>
                </div>
            </div>
        </div>

    </div>

    <!-- CREATE GROUP MODAL -->
    <div id="createGroupModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Create New Group</h3>
            <label class="form-label">Group Name</label>
            <input type="text" id="groupName" class="form-input" placeholder="e.g. AI Research Squad">
            
            <label class="form-label">Description (Optional)</label>
            <input type="text" id="groupDesc" class="form-input" placeholder="What's this group about?">
            
            <label class="form-label">Group Icon</label>
            <div class="icon-selector" id="iconSelector">
                <div class="icon-option selected" onclick="selectIcon(this, 'ðŸš€')">ðŸš€</div>
                <div class="icon-option" onclick="selectIcon(this, 'ðŸ“š')">ðŸ“š</div>
                <div class="icon-option" onclick="selectIcon(this, 'ðŸ’»')">ðŸ’»</div>
                <div class="icon-option" onclick="selectIcon(this, 'âš¡')">âš¡</div>
                <div class="icon-option" onclick="selectIcon(this, 'ðŸ§¬')">ðŸ§¬</div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCreateModal()">Cancel</button>
                <button class="btn-create" onclick="createGroup()">Create</button>
            </div>
        </div>
    </div>

    <div id="permissionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--danger); display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-lock"></i> Restricted Access
            </h3>
            <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem;">
                The <strong><span id="targetBranch"></span></strong> channel requires verification. Please enter your Roll Number to request permission.
            </p>
            
            <label class="form-label">Roll Number</label>
            <input type="text" id="rollNoInput" class="form-input" placeholder="e.g. 21BCS045">
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closePermissionModal()">Cancel</button>
                <button class="btn-create" id="sendRequestBtn" onclick="submitPermissionRequest()">Send Request</button>
            </div>
        </div>
    </div>

    <div class="ai-widget" id="ai-widget">
        <div class="ai-minimized" onclick="toggleChat()">
            <span class="widget-status"></span>
            <span>AI Assistant</span>
        </div>
        <div class="chat-interface">
            <div class="chat-header">
                <div class="ai-profile">
                    <div class="ai-avatar-small"><i class="fa-solid fa-robot"></i></div>
                    <span>NexGen Bot</span>
                </div>
                <button class="close-chat" onclick="toggleChat()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="chat-body" id="chat-box"></div>
            <div class="chat-footer">
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask anything..." onkeypress="handleEnter(event)">
                    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    /* THEME TOGGLE */
    const toggleBtn = document.getElementById('theme-toggle');
    const body = document.body;
    const icon = toggleBtn.querySelector('i');
    if(localStorage.getItem('theme') === 'dark') { body.setAttribute('data-theme', 'dark'); icon.classList.replace('fa-moon', 'fa-sun'); }
    toggleBtn.addEventListener('click', () => {
        if(body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme'); icon.classList.replace('fa-sun', 'fa-moon'); localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark'); icon.classList.replace('fa-moon', 'fa-sun'); localStorage.setItem('theme', 'dark');
        }
    });

    /* MOBILE SIDEBAR TOGGLE */
    function toggleMainSidebar() {
        document.getElementById('mainSidebar').classList.toggle('open');
    }
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('mainSidebar');
        const btn = document.querySelector('.mobile-menu-btn');
        if (window.innerWidth <= 1024 && !sidebar.contains(event.target) && !btn.contains(event.target) && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        }
    });

    /* --- PERMISSION & BRANCH LOGIC --- */
    let currentRestrictedBranch = null;
    const restrictedBranches = ['CSE', 'ECE', 'MECH', 'CIVIL'];

    function selectBranch(element, branchName) {
        // Update Active State
        const allBranches = document.querySelectorAll('.branch-item');
        allBranches.forEach(b => b.classList.remove('active'));
        element.classList.add('active');

        // Update UI
        document.getElementById('currentBranchName').innerText = branchName;
        
        // Check Restriction
        const isRestricted = restrictedBranches.includes(branchName);

        if (isRestricted) {
            // Lock UI Logic
            currentRestrictedBranch = branchName;
            document.getElementById('channelIconWrapper').innerHTML = '<i class="fa-solid fa-lock" style="color:#ef4444; font-size:1.2rem;"></i>';
            showLockedScreen(branchName);
            openPermissionModal(branchName); // Auto-trigger modal
        } else {
            // Standard Access
            currentRestrictedBranch = null;
            document.getElementById('channelIconWrapper').innerHTML = '<span style="color:var(--text-muted); font-size:1.5rem;">#</span>';
            loadBranchChat(branchName, branchName, false);
        }
    }

    function showLockedScreen(branchName) {
        const feed = document.getElementById('mainChatFeed');
        const inputArea = document.getElementById('chatInputArea');
        
        // Hide Input Area for locked channels
        inputArea.style.display = 'none';

        feed.innerHTML = `
            <div class="locked-view">
                <i class="fa-solid fa-lock locked-icon"></i>
                <div class="locked-title">Access to ${branchName} is Restricted</div>
                <p>This channel is reserved for verified students of this branch.</p>
                <button class="locked-btn" onclick="openPermissionModal('${branchName}')">Request Permission</button>
            </div>
        `;
    }

    /* PERMISSION MODAL FUNCTIONS */
    function openPermissionModal(branchName) {
        const name = branchName || currentRestrictedBranch; 
        document.getElementById('targetBranch').innerText = name;
        document.getElementById('permissionModal').style.display = 'flex';
        document.getElementById('rollNoInput').value = ''; 
        document.getElementById('rollNoInput').focus();
    }

    function closePermissionModal() {
        document.getElementById('permissionModal').style.display = 'none';
    }

    function submitPermissionRequest() {
        const rollNo = document.getElementById('rollNoInput').value.trim();
        if(!rollNo) {
            alert("Please enter your Roll Number.");
            return;
        }

        const btn = document.getElementById('sendRequestBtn');
        const originalText = btn.innerText;
        btn.innerText = "Verifying...";
        btn.disabled = true;

        // Simulate API verification delay
        setTimeout(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            closePermissionModal();
            
            // Grant Access Simulation
            document.getElementById('channelIconWrapper').innerHTML = '<i class="fa-solid fa-lock-open" style="color:var(--success); font-size:1.2rem;"></i>';
            loadBranchChat(currentRestrictedBranch, currentRestrictedBranch, true); // true = unlocked
        }, 1200);
    }

    function loadBranchChat(branchName, branchCode, isUnlocked) {
        const feed = document.getElementById('mainChatFeed');
        const inputArea = document.getElementById('chatInputArea');
        
        // Show Input Area
        inputArea.style.display = 'block';

        const subText = isUnlocked 
            ? `<span style="color:var(--success);"><i class="fa-solid fa-check-circle"></i> Access Granted</span>` 
            : 'Public Channel';

        feed.innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.9rem;">
                <i class="fa-solid fa-arrow-right-arrow-left"></i> Switched to <strong>${branchName}</strong>
            </div>
            <div class="message-group">
                <div class="user-avatar" style="background:#64748b;">SYS</div>
                <div class="msg-content">
                    <div class="msg-header"><span class="username">System</span> <span class="timestamp">Now</span></div>
                    <div class="msg-text">Welcome to the ${branchCode} channel. <br><strong>Status: ${subText}</strong></div>
                </div>
            </div>
        `;
    }

    /* CHANNEL SELECT (Legacy from previous, updated for lock checks) */
    function selectChannel(el, channelName, isGroup = false) {
        // Simple visual toggle for now, keeps current main branch view context
        document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('currentChannelName').innerText = channelName;
    }

    /* DIRECT MESSAGE & ATTACHMENTS (Standard) */
    function openDM(userName) {
        document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('active'));
        document.getElementById('channelIconWrapper').innerHTML = '<i class="fa-solid fa-at" style="color:var(--text-muted); font-size:1.2rem;"></i>';
        document.getElementById('currentChannelName').innerText = userName;
        const feed = document.getElementById('mainChatFeed');
        document.getElementById('chatInputArea').style.display = 'block';
        feed.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-muted);">
                <div class="user-avatar" style="background:var(--primary); width:60px; height:60px; font-size:1.5rem; margin:0 auto 15px auto; border-radius:50%;">${userName.charAt(0)}</div>
                <h3 style="color:var(--text-main);">${userName}</h3>
                <p>This is the beginning of your direct message history.</p>
            </div>
        `;
    }

    function viewAttachment(url) {
        const win = window.open("", "_blank");
        // FIXED: Escaped forward slashes in closing tags to prevent script termination
        win.document.write(`<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f3f4f6;font-family:sans-serif;color:#333;"><h1>${url}</h1><\/body><\/html>`);
    }

    /* CHAT MESSAGING */
    function handleMainEnter(e) { if(e.key === 'Enter') sendMainMessage(); }
    function sendMainMessage() {
        const input = document.getElementById('mainChatInput');
        const text = input.value.trim();
        if(!text) return;
        const feed = document.getElementById('mainChatFeed');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        feed.insertAdjacentHTML('beforeend', `
            <div class="message-group">
                <div class="user-avatar" style="background:#8b5cf6;">JD</div>
                <div class="msg-content">
                    <div class="msg-header"><span class="username">John Doe</span> <span class="timestamp">${time}</span></div>
                    <div class="msg-text">${text}</div>
                </div>
            </div>
        `);
        input.value = '';
        feed.scrollTop = feed.scrollHeight;
    }

    /* CREATE GROUP LOGIC */
    let selectedIcon = 'ðŸš€';
    function openCreateModal() { document.getElementById('createGroupModal').style.display = 'flex'; }
    function closeCreateModal() { document.getElementById('createGroupModal').style.display = 'none'; }
    function selectIcon(el, icon) {
        document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        selectedIcon = icon;
    }
    function createGroup() {
        const name = document.getElementById('groupName').value;
        if(!name) { alert('Please enter a group name'); return; }
        const list = document.getElementById('groupList');
        const item = document.createElement('div');
        item.className = 'channel-item';
        item.setAttribute('onclick', `selectChannel(this, '${name}', true)`);
        item.innerHTML = `<i class="fa-solid fa-lock channel-hash" style="font-size:0.8rem;"></i> <span class="channel-text">${name}</span>`;
        list.appendChild(item);
        closeCreateModal();
        document.getElementById('groupName').value = '';
    }

    /* --- CHATBOT LOGIC --- */
    const widget = document.getElementById('ai-widget');
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    let firstOpen = true;

    function toggleChat() {
        widget.classList.toggle('expanded');
        if(widget.classList.contains('expanded') && firstOpen) {
            firstOpen = false;
            // Add greeting automatically with typing effect
            setTimeout(() => {
                const typingId = showTyping();
                setTimeout(() => {
                    removeTyping(typingId);
                    addMessage("ai", "Hi John, how can I help you today?");
                }, 1000);
            }, 500);
        }
    }

    function handleEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }

    function sendMessage() {
        const text = chatInput.value.trim();
        if(!text) return;
        
        // 1. Add User Message
        addMessage("user", text);
        chatInput.value = '';

        // 2. Show Typing Indicator
        const typingId = showTyping();

        // 3. Simulate AI Response (Delay)
        setTimeout(() => {
            removeTyping(typingId);
            addMessage("ai", "I'm analyzing your academic data. Here is what I found...");
        }, 1500);
    }

    function addMessage(sender, text) {
        const div = document.createElement('div');
        div.className = `msg msg-${sender}`;
        div.textContent = text;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    function showTyping() {
        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.className = 'typing-indicator';
        div.id = id;
        div.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
        chatBox.appendChild(div);
        scrollToBottom();
        return id;
    }

    function removeTyping(id) {
        const el = document.getElementById(id);
        if(el) el.remove();
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>