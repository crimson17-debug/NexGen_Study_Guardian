<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Editor | NexGen</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

<style>
/* --- THEME VARIABLES --- */
:root {
    --primary: #3b82f6;
    --primary-glow: rgba(59, 130, 246, 0.4);
    --secondary: #8b5cf6;
    --bg-body: #f8fafc;
    --bg-sidebar: rgba(255, 255, 255, 0.85);
    --bg-card: #ffffff;
    --bg-hover: #f1f5f9;
    --bg-input: rgba(255, 255, 255, 0.5);
    --border: #e2e8f0;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    --glass-blur: blur(12px);
    
    /* Editor Specific - Improved */
    --editor-bg: #0d1117; /* GitHub Dark Dimmed vibe */
    --editor-gutter: #161b22;
    --editor-border: #30363d;
    --console-bg: #0d1117;
    --console-text: #3fb950;
    --accent-glow: 0 0 20px rgba(59, 130, 246, 0.15);
}

[data-theme="dark"] {
    --primary: #818cf8;
    --primary-glow: rgba(129, 140, 248, 0.3);
    --secondary: #c084fc;
    --bg-body: linear-gradient(135deg, #020617 0%, #0f172a 50%, #172554 100%);
    --bg-sidebar: rgba(15, 23, 42, 0.6);
    --bg-card: rgba(30, 41, 59, 0.6);
    --bg-hover: rgba(51, 65, 85, 0.5);
    --bg-input: rgba(15, 23, 42, 0.6);
    --border: rgba(255, 255, 255, 0.08);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --glass-blur: blur(20px); 
}

/* --- RESET & BASE --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: background 0.4s ease, color 0.2s ease, border-color 0.3s ease; }
body { height: 100vh; display: flex; background: var(--bg-body); background-size: 200% 200%; color: var(--text-main); overflow: hidden; }

/* --- SIDEBAR & HEADER (KEPT AS REQUESTED) --- */
.sidebar { width: 270px; background: var(--bg-sidebar); backdrop-filter: var(--glass-blur); border-right: 1px solid var(--border); padding: 24px 16px; display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; overflow-y: auto; }
.sidebar::-webkit-scrollbar { width: 5px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.logo-container { display: flex; align-items: center; gap: 12px; padding: 0 12px 20px; }
.logo-icon { width: 34px; height: 34px; background: linear-gradient(135deg, var(--primary), #4f46e5); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px var(--primary-glow); overflow: hidden; }
.logo-img { width: 100%; height: 100%; object-fit: cover; }
.logo-text { font-size: 1.3rem; font-weight: 700; color: var(--text-main); }
.sidebar-divider { height: 1px; background: var(--border); margin: 8px 8px 20px; }
.section-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; margin: 20px 12px 10px; }
.nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; color: var(--text-muted); text-decoration: none; font-size: 0.95rem; font-weight: 500; margin-bottom: 4px; cursor: pointer; position: relative; overflow: hidden; z-index: 1; }
.nav-item::before { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: var(--bg-hover); z-index: -1; border-radius: 12px; transform: scaleX(0); transform-origin: left; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
.nav-item.active { color: var(--primary); font-weight: 600; }
.nav-item.active::before { transform: scaleX(1); background: var(--bg-hover); opacity: 0.5; }
.nav-item.active i { color: var(--primary); }
.nav-item:hover { color: var(--text-main); transform: translateX(6px); }
.nav-item:hover::before { transform: scaleX(1); }
.nav-item i { width: 24px; text-align: center; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
.nav-item:hover i { transform: scale(1.15) rotate(5deg); color: var(--primary); }

.main-layout { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
.top-bar { height: 72px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; background: var(--bg-sidebar); backdrop-filter: var(--glass-blur); border-bottom: 1px solid var(--border); z-index: 10; }
.search-wrapper { position: relative; width: 400px; }
.search-input { width: 100%; padding: 11px 16px 11px 44px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); font-size: 0.9rem; }
.search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); background: var(--bg-card); }
.search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.header-actions { display: flex; align-items: center; gap: 16px; }
.action-btn { width: 42px; height: 42px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
.action-btn:hover { background: var(--bg-hover); color: var(--text-main); border-color: var(--primary); transform: translateY(-2px); }
.profile-avatar { width: 42px; height: 42px; border-radius: 12px; background: linear-gradient(135deg, #6366f1, #d946ef); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; cursor: pointer; }
.mobile-menu-btn { display: none; margin-right: 15px; background: transparent; border: none; font-size: 1.4rem; color: var(--text-muted); cursor: pointer; }

/* --- REDESIGNED EDITOR WORKSPACE --- */
.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 20px;
    gap: 16px;
    background: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.03) 0%, transparent 40%);
}

/* New Toolbar Style */
.editor-toolbar {
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-card); padding: 8px 12px; border-radius: 16px;
    border: 1px solid var(--border); box-shadow: var(--shadow);
    flex-shrink: 0; backdrop-filter: blur(10px);
}
.toolbar-left, .toolbar-right { display: flex; align-items: center; gap: 10px; }

.lang-select-wrapper {
    position: relative;
}
.lang-select {
    padding: 8px 36px 8px 16px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--bg-input); color: var(--text-main); font-weight: 600;
    cursor: pointer; outline: none; appearance: none;
    font-size: 0.9rem; transition: all 0.3s;
}
.lang-select:hover, .lang-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
.lang-select-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; font-size: 0.8rem; }

.toolbar-btn {
    padding: 8px 12px; border-radius: 10px; border: 1px solid transparent;
    background: transparent; color: var(--text-muted); font-weight: 500; font-size: 0.9rem;
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: all 0.2s;
}
.toolbar-btn:hover { background: var(--bg-hover); color: var(--text-main); }
.toolbar-btn.primary { background: var(--bg-hover); color: var(--primary); border-color: var(--border); }
.toolbar-btn.primary:hover { border-color: var(--primary); transform: translateY(-1px); }

.run-btn {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white; border: none; padding: 8px 24px; border-radius: 10px;
    font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: all 0.3s; box-shadow: 0 4px 15px var(--primary-glow);
}
.run-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--primary-glow); filter: brightness(1.1); }
.run-btn:active { transform: translateY(0); }

/* Main Split Area with Neon Glow */
.editor-main-area {
    flex: 1; display: flex; gap: 16px; overflow: hidden;
    position: relative;
}

/* Left Pane: Code + Console */
.editor-left-pane {
    flex: 1; display: flex; flex-direction: column; gap: 16px; min-width: 0;
}

/* Code Area - THE MAJOR UPGRADE */
.code-wrapper {
    flex: 1; display: flex; flex-direction: column;
    background: var(--editor-bg); border-radius: 16px;
    overflow: hidden; border: 1px solid var(--editor-border);
    box-shadow: var(--accent-glow); position: relative;
}

/* Glowing Top Line */
.code-glow-line {
    position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
    background-size: 200% 100%; animation: shimmer 3s infinite linear; opacity: 0; transition: opacity 0.3s;
    z-index: 10;
}
.code-wrapper.running .code-glow-line { opacity: 1; }

@keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

.editor-inner { display: flex; flex: 1; overflow: hidden; position: relative; }

/* CodeJar uses a pre tag for highlighting over a div */
.editor-viewport {
    flex: 1; position: relative; overflow: auto;
}

#code-editor {
    min-height: 100%;
    font-family: 'Fira Code', monospace;
    font-size: 14px;
    line-height: 1.6;
    color: #c9d1d9;
    padding: 20px;
    tab-size: 4;
    outline: none;
    caret-color: var(--primary);
}

/* Prism Overrides for Dark Theme integration */
code[class*="language-"], pre[class*="language-"] { 
    text-shadow: none !important; font-family: 'Fira Code', monospace !important; 
}
.token.operator { background: none !important; }

/* Status Bar */
.editor-status-bar {
    height: 30px; background: var(--editor-gutter); border-top: 1px solid var(--editor-border);
    display: flex; align-items: center; justify-content: flex-end; padding: 0 16px;
    font-family: 'Fira Code', monospace; font-size: 11px; color: #8b949e; gap: 16px;
    user-select: none;
}
.status-item { display: flex; align-items: center; gap: 6px; }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: #3fb950; }

/* Console Area */
.console-panel {
    height: 180px; background: var(--console-bg);
    border-radius: 16px; border: 1px solid var(--editor-border);
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); flex-shrink: 0;
}
.console-header {
    background: rgba(255,255,255,0.03); padding: 10px 20px;
    font-size: 0.75rem; font-weight: 700; color: #8b949e; text-transform: uppercase; letter-spacing: 0.1em;
    border-bottom: 1px solid var(--editor-border);
    display: flex; justify-content: space-between; align-items: center;
}
.console-body {
    flex: 1; padding: 15px 20px; font-family: 'Fira Code', monospace;
    font-size: 13px; color: var(--console-text); overflow-y: auto;
    scrollbar-color: #30363d transparent;
}
.console-body::-webkit-scrollbar { width: 8px; }
.console-body::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
.console-body::-webkit-scrollbar-track { background: transparent; }
.log-error { color: #f85149; }
.log-warn { color: #d29922; }
.log-info { color: #58a6ff; }
.log-sys { color: #8b949e; font-style: italic; }

.console-clear { cursor: pointer; color: #8b949e; transition: color 0.2s; font-size: 0.9em; }
.console-clear:hover { color: #f85149; }

/* Right Pane: Team Chat (Kept functionality, refined style) */
.team-chat-panel {
    width: 320px; background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border);
    display: flex; flex-direction: column; overflow: hidden;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, margin 0.3s;
    backdrop-filter: blur(20px);
}
.team-chat-panel.collapsed { width: 0; opacity: 0; border: none; margin-left: 0; }
.tc-header { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
.tc-status { width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px rgba(16, 185, 129, 0.6); animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.9); } }
.tc-body { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: rgba(0,0,0,0.02); }
.tc-msg { font-size: 0.85rem; padding: 10px 14px; border-radius: 14px; max-width: 85%; line-height: 1.4; position: relative; }
.tc-msg-remote { align-self: flex-start; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); border-bottom-left-radius: 2px; }
.tc-msg-local { align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-bottom-right-radius: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.tc-footer { padding: 12px; border-top: 1px solid var(--border); background: var(--bg-card); }
.tc-input-wrapper { display: flex; gap: 8px; background: var(--bg-input); border: 1px solid var(--border); padding: 4px 4px 4px 12px; border-radius: 24px; }
.tc-input { flex: 1; background: transparent; border: none; outline: none; color: var(--text-main); font-size: 0.9rem; padding: 8px 0; }
.tc-send-btn { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
.tc-send-btn:hover { transform: scale(1.05); }

/* TOAST NOTIFICATION */
#toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast {
    background: rgba(15, 23, 42, 0.9); color: white; padding: 12px 24px; border-radius: 12px;
    display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    opacity: 0; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast i { color: #10b981; }

/* AI WIDGET (Unchanged logic, just ensure z-index) */
.ai-widget { position: absolute; bottom: 30px; right: 30px; z-index: 999; }
.ai-minimized { background: var(--bg-card); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 50px; padding: 12px 24px; box-shadow: var(--shadow); color: var(--text-main); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: transform 0.3s; }
.ai-minimized:hover { transform: translateY(-3px) scale(1.02); }
.widget-status { width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981; }
.chat-interface { position: absolute; bottom: 0; right: 0; width: 380px; height: 550px; background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); transition: all 0.4s; }
.ai-widget.expanded .chat-interface { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }
.ai-widget.expanded .ai-minimized { opacity: 0; pointer-events: none; display: none; }
.chat-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.05); }
.ai-profile { display: flex; align-items: center; gap: 10px; font-weight: 600; }
.ai-avatar-small { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; }
.close-chat { background: none; border: none; color: var(--text-muted); cursor: pointer; }
.chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
.msg { padding: 12px 16px; font-size: 0.9rem; line-height: 1.5; max-width: 85%; border-radius: 12px; }
.msg-user { align-self: flex-end; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border-radius: 18px 18px 0 18px; }
.msg-ai { align-self: flex-start; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-main); border-radius: 18px 18px 18px 0; }
.chat-footer { padding: 16px; }
.chat-input-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 50px; padding: 6px 6px 6px 16px; display: flex; align-items: center; }
.chat-input { flex: 1; border: none; background: transparent; outline: none; color: var(--text-main); }
.send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; }

/* Typing Indicator Animation */
.typing-indicator { display: flex; gap: 4px; padding: 12px 16px; align-self: flex-start; background: var(--bg-hover); border-radius: 18px; border: 1px solid var(--border); width: fit-content; }
.dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

/* Mobile */
@media (max-width: 1024px) {
    .sidebar { position: fixed; transform: translateX(-100%); transition: transform 0.3s; z-index: 30; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.open { transform: translateX(0); }
    .mobile-menu-btn { display: block; }
    .editor-container { padding: 10px; }
    .team-chat-panel { position: absolute; right: 0; top: 72px; bottom: 0; z-index: 25; width: 85%; max-width: 320px; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
    .team-chat-panel.collapsed { transform: translateX(100%); width: 85%; opacity: 1; }
}
</style>
</head>
<body data-theme="dark">

<div id="toast-container"></div>

<div class="sidebar" id="mainSidebar">
    <div class="logo-container">
        <div class="logo-icon"><img src="NexGen-logo.jpg" alt="" class="logo-img" style="background:#fff;"></div>
        <span class="logo-text">NexGen</span>
    </div>
    <div class="sidebar-divider"></div>
    <a href="dashboard.html" class="nav-item"><i class="fa-solid fa-house-chimney"></i>Dashboard</a>
    <div class="section-label">Academics</div>
    <a href="aipapergen.html" class="nav-item"><i class="fa-solid fa-wand-magic-sparkles"></i>AI Paper Gen</a>
    <a href="syllabus.html" class="nav-item"><i class="fa-solid fa-crosshairs"></i>Syllabus Tracker</a>
    <div class="section-label">Community</div>
    <a href="notes.html" class="nav-item"><i class="fa-solid fa-brain"></i>Notes Repo</a>
    <a href="channels.html" class="nav-item"><i class="fa-solid fa-code-branch"></i>Branch Channel</a>
    <div class="section-label">Tools</div>
    <a href="#" class="nav-item active"><i class="fa-solid fa-terminal"></i>Code Editor</a>
    <div class="section-label">Database</div>
    <a href="archive.html" class="nav-item"><i class="fa-solid fa-database"></i>PYQ Archive</a>
    <a href="syllabus-list.html" class="nav-item"><i class="fa-solid fa-list-check"></i>Syllabus List</a>
    <a href="notes.html" class="nav-item"><i class="fa-solid fa-folder-open"></i>Notes Library</a>
</div>

<div class="main-layout">
    
    <div class="top-bar">
        <div style="display: flex; align-items: center;">
            <button class="mobile-menu-btn" onclick="toggleMainSidebar()"><i class="fa-solid fa-bars"></i></button>
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" placeholder="Search files, snippets...">
            </div>
        </div>
        <div class="header-actions">
            <button class="action-btn" id="theme-toggle"><i class="fa-solid fa-sun"></i></button>
            <button class="action-btn"><i class="fa-regular fa-bell"></i></button>
            <div class="profile-avatar">JD</div>
        </div>
    </div>

    <div class="editor-container">
        
        <div class="editor-toolbar">
            <div class="toolbar-left">
                <div class="lang-select-wrapper">
                    <select class="lang-select" id="langSelect" onchange="changeLanguage()">
                        <option value="python">Python 3.10</option>
                        <option value="javascript">JavaScript (Node)</option>
                        <option value="cpp">C++ 17</option>
                        <option value="java">Java 11</option>
                    </select>
                    <i class="fa-solid fa-chevron-down lang-select-icon"></i>
                </div>
                <div style="width:1px; height:24px; background:var(--border); margin:0 8px;"></div>
                <button class="toolbar-btn primary" title="Save File (Ctrl+S)" onclick="saveCode()"><i class="fa-regular fa-floppy-disk"></i> Save</button>
                <button class="toolbar-btn" title="Download File" onclick="downloadCode()"><i class="fa-solid fa-download"></i> Download</button>
                <button class="toolbar-btn" title="Format Code"><i class="fa-solid fa-align-left"></i> Format</button>
            </div>
            <div class="toolbar-right">
                <button class="action-btn" onclick="toggleTeamChat()" title="Toggle Team Chat" style="border-color:var(--primary-glow); color:var(--primary); background:rgba(59,130,246,0.1);">
                    <i class="fa-solid fa-comments"></i>
                </button>
                <button class="run-btn" onclick="runCode()">
                    <i class="fa-solid fa-play"></i> Run Code
                </button>
            </div>
        </div>

        <div class="editor-main-area">
            
            <div class="editor-left-pane">
                <div class="code-wrapper" id="codeWrapper">
                    <div class="code-glow-line"></div>
                    <div class="editor-inner">
                        <div class="editor-viewport">
                            <div id="code-editor" class="language-python"></div>
                        </div>
                    </div>
                    <div class="editor-status-bar">
                        <div class="status-item"><i class="fa-solid fa-code-branch"></i> main</div>
                        <div class="status-item" id="cursor-pos">Ln 1, Col 1</div>
                        <div class="status-item">UTF-8</div>
                        <div class="status-item"><span class="status-dot"></span> Ready</div>
                    </div>
                </div>

                <div class="console-panel">
                    <div class="console-header">
                        <span><i class="fa-solid fa-terminal" style="margin-right:8px; color:var(--secondary);"></i> Terminal</span>
                        <span class="console-clear" onclick="clearConsole()"><i class="fa-solid fa-ban"></i> Clear</span>
                    </div>
                    <div class="console-body" id="consoleOutput">
                        <div class="log-sys">nexgen-terminal:~$ ready for execution...</div>
                    </div>
                </div>
            </div>

            <div class="team-chat-panel collapsed" id="teamChatPanel">
                <div class="tc-header">
                    <span><i class="fa-solid fa-users"></i> Team Chat</span>
                    <div class="tc-status" title="Live"></div>
                </div>
                <div class="tc-body" id="tcBody">
                    <div class="tc-msg tc-msg-remote">
                        <span style="font-size:0.7em; font-weight:700; display:block; margin-bottom:4px; opacity:0.7;">Alex</span>
                        Hey! I fixed the bug in line 15.
                    </div>
                    <div class="tc-msg tc-msg-remote">
                        <span style="font-size:0.7em; font-weight:700; display:block; margin-bottom:4px; opacity:0.7;">Sarah</span>
                        Nice. Can we test the new function now?
                    </div>
                </div>
                <div class="tc-footer">
                    <div class="tc-input-wrapper">
                        <input type="text" class="tc-input" id="tcInput" placeholder="Message..." onkeypress="handleTeamChatEnter(event)">
                        <button class="tc-send-btn" onclick="sendTeamMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <div class="ai-widget" id="ai-widget">
        <div class="ai-minimized" onclick="toggleChat()">
            <span class="widget-status"></span>
            <span>AI Assistant</span>
        </div>
        <div class="chat-interface">
            <div class="chat-header">
                <div class="ai-profile">
                    <div class="ai-avatar-small"><i class="fa-solid fa-robot"></i></div>
                    <span>NexGen Bot</span>
                </div>
                <button class="close-chat" onclick="toggleChat()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="chat-body" id="chat-box"></div>
            <div class="chat-footer">
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask about code..." onkeypress="handleEnter(event)">
                    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script type="module">
    import { CodeJar } from 'https://cdn.jsdelivr.net/npm/codejar@3.7.0/codejar.js';

    // Highlight Function
    const highlight = editor => {
        // Map editor value to Prism
        editor.innerHTML = Prism.highlight(
            editor.textContent, 
            Prism.languages[currentLang] || Prism.languages.javascript, 
            currentLang
        );
    }

    const editorElement = document.querySelector('#code-editor');
    // Initialize CodeJar
    const jar = CodeJar(editorElement, highlight);
    window.jar = jar; // Make accessible globally

    // Track Cursor
    editorElement.addEventListener('click', updateCursor);
    editorElement.addEventListener('keyup', updateCursor);

    function updateCursor() {
        const selection = window.getSelection();
        if(!selection.rangeCount) return;
        // Simple mock cursor position for UI effect
        const text = jar.toString();
        const lines = text.split('\n').length;
        const chars = text.length;
        document.getElementById('cursor-pos').innerText = `Ln ${lines}, Ch ${chars}`;
    }

    // Set Initial Content
    jar.updateCode(`# Python 3
def main():
    print("Hello from NexGen Editor")
    x = 10
    if x > 5:
        print("System is operational")

main()`);
</script>

<script>
    /* GLOBAL VARS */
    let currentLang = 'python';

    /* THEME TOGGLE */
    const toggleBtn = document.getElementById('theme-toggle');
    const body = document.body;
    const icon = toggleBtn.querySelector('i');
    
    // Default to dark
    if(!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark');
    if(localStorage.getItem('theme') === 'light') { 
        body.removeAttribute('data-theme'); 
        icon.classList.replace('fa-sun', 'fa-moon'); 
    }

    toggleBtn.addEventListener('click', () => {
        if(body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme'); icon.classList.replace('fa-sun', 'fa-moon'); localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark'); icon.classList.replace('fa-moon', 'fa-sun'); localStorage.setItem('theme', 'dark');
        }
    });

    /* MOBILE SIDEBAR */
    function toggleMainSidebar() {
        document.getElementById('mainSidebar').classList.toggle('open');
    }
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('mainSidebar');
        const btn = document.querySelector('.mobile-menu-btn');
        if (window.innerWidth <= 1024 && !sidebar.contains(event.target) && !btn.contains(event.target) && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        }
    });

    /* EDITOR LOGIC */
    function changeLanguage() {
        const lang = document.getElementById('langSelect').value;
        const editorDiv = document.getElementById('code-editor');
        
        // Remove old class, add new class for Prism
        editorDiv.classList.remove(`language-${currentLang}`);
        
        currentLang = lang;
        // Map to prism format
        let prismLang = lang;
        if(lang === 'cpp') prismLang = 'cpp'; 
        
        editorDiv.classList.add(`language-${prismLang}`);

        if(lang === 'python') {
            window.jar.updateCode(`# Python 3\ndef main():\n    print("Hello from Python")\n    # Try removing the indent below to see an error!\n    print("System Check OK")\n\nmain()`);
        } else if(lang === 'javascript') {
            window.jar.updateCode(`// JavaScript (Node)\nconsole.log("Hello from NodeJS");\n\nconst test = () => {\n  return true;\n};\n\ntest();`);
        } else if(lang === 'cpp') {
            window.jar.updateCode(`// C++ 17\n#include <iostream>\n\nint main() {\n    std::cout << "Hello from C++" << std::endl;\n    // Try removing the semicolon below to see an error\n    int x = 10;\n    return 0;\n}`);
        } else if(lang === 'java') {
            window.jar.updateCode(`// Java 11\npublic class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello from Java");\n    }\n}`);
        }
        
        // Trigger highlight update
        // (CodeJar handles this automatically on updateCode)
    }

    // 1. DOWNLOAD FUNCTIONALITY
    function downloadCode() {
        const code = window.jar.toString();
        const lang = document.getElementById('langSelect').value;
        let ext = 'txt';
        let mime = 'text/plain';

        if(lang === 'python') { ext = 'py'; mime = 'text/x-python'; }
        else if(lang === 'javascript') { ext = 'js'; mime = 'text/javascript'; }
        else if(lang === 'cpp') { ext = 'cpp'; mime = 'text/x-c++src'; }
        else if(lang === 'java') { ext = 'java'; mime = 'text/x-java-source'; }

        const blob = new Blob([code], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nexgen_script.${ext}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('File downloaded successfully', 'success');
    }

    // 2. SAVE FUNCTIONALITY (MOCK)
    function saveCode() {
        // Here you would typically send an API request
        const btn = document.querySelector('.toolbar-btn.primary');
        const originalHtml = btn.innerHTML;
        
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            showToast('Project saved to cloud', 'success');
        }, 800);
    }

    function showToast(msg, type) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        const icon = type === 'success' ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-triangle-exclamation" style="color:#f85149;"></i>';
        toast.innerHTML = `${icon} <span>${msg}</span>`;
        
        container.appendChild(toast);
        
        // Trigger animation
        requestAnimationFrame(() => { toast.classList.add('show'); });
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 3. SMART RUN & ERROR LOGIC
    function runCode() {
        const code = window.jar.toString();
        const lang = document.getElementById('langSelect').value;
        const outputDiv = document.getElementById('consoleOutput');
        const runBtn = document.querySelector('.run-btn');
        const codeWrapper = document.getElementById('codeWrapper');
        
        // Visual Loading
        runBtn.innerHTML = '<i class="fa-solid fa-gear fa-spin"></i> Compiling...';
        codeWrapper.classList.add('running'); // Triggers glow line
        outputDiv.innerHTML += `<br><span class="log-sys">> Compiling ${lang}...</span>`;
        outputDiv.scrollTop = outputDiv.scrollHeight;

        setTimeout(() => {
            let error = null;
            let result = "";

            // --- MOCK ERROR DETECTION LOGIC ---
            if(lang === 'cpp' || lang === 'java') {
                // Check for missing semicolon at end of non-empty lines (very basic regex)
                // Excludes lines ending in { } > comments or includes
                const lines = code.split('\n');
                for(let i=0; i<lines.length; i++) {
                    const l = lines[i].trim();
                    if(l.length > 0 && !l.startsWith('//') && !l.startsWith('#') && !l.endsWith(';') && !l.endsWith('{') && !l.endsWith('}') && !l.endsWith('>')) {
                        error = `SyntaxError: expected ';' at line ${i+1}`;
                        break;
                    }
                }
                if(!error) result = "Build Success.\n> Output: Hello from " + (lang==='cpp'?'C++':'Java');
            } 
            else if (lang === 'python') {
                // Check for Def without colon
                if(/def\s+\w+\(.*\)(?!\:)/.test(code)) {
                    error = "SyntaxError: invalid syntax (expected ':')";
                }
                // Very crude indentation check
                else if(code.includes('def main():') && !code.includes('    ')) {
                    error = "IndentationError: expected an indented block";
                }
                else {
                    result = "Hello from Python\n[Process finished with exit code 0]";
                }
            }
            else if (lang === 'javascript') {
                 // JS is forgiving, but let's check for const assignment without value
                 if(/const\s+\w+\s*;/.test(code)) {
                     error = "SyntaxError: Missing initializer in const declaration";
                 } else {
                     result = "Hello from NodeJS\n> true";
                 }
            }

            // Display Result
            if(error) {
                outputDiv.innerHTML += `<br><span class="log-error">x ${error}</span><br><span class="log-sys">Compilation Failed.</span>`;
                showToast('Compilation Failed', 'error');
            } else {
                outputDiv.innerHTML += `<br><span class="log-info">${result.replace(/\n/g, '<br>')}</span>`;
            }

            // Cleanup Visuals
            outputDiv.scrollTop = outputDiv.scrollHeight;
            runBtn.innerHTML = '<i class="fa-solid fa-play"></i> Run Code';
            codeWrapper.classList.remove('running');

        }, 1200);
    }

    function clearConsole() {
        document.getElementById('consoleOutput').innerHTML = '<div class="log-sys">nexgen-terminal:~$ cleared</div>';
    }

    /* TEAM CHAT LOGIC (Unchanged but styled) */
    function toggleTeamChat() {
        document.getElementById('teamChatPanel').classList.toggle('collapsed');
    }
    function handleTeamChatEnter(e) {
        if(e.key === 'Enter') sendTeamMessage();
    }
    function sendTeamMessage() {
        const input = document.getElementById('tcInput');
        const text = input.value.trim();
        if(!text) return;
        const chatBody = document.getElementById('tcBody');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'tc-msg tc-msg-local';
        msgDiv.innerHTML = `<span style="font-size:0.7em; font-weight:700; display:block; margin-bottom:4px; opacity:0.8;">You</span>${text}`;
        chatBody.appendChild(msgDiv);
        input.value = '';
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    /* AI CHATBOT LOGIC (Unchanged) */
    const widget = document.getElementById('ai-widget');
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    let firstOpen = true;

    function toggleChat() {
        widget.classList.toggle('expanded');
        if(widget.classList.contains('expanded') && firstOpen) {
            firstOpen = false;
            setTimeout(() => {
                const typingId = showTyping();
                setTimeout(() => {
                    removeTyping(typingId);
                    addMessage("ai", "I can help debug your code or explain algorithms.");
                }, 1000);
            }, 500);
        }
    }
    function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
    function sendMessage() {
        const text = chatInput.value.trim();
        if(!text) return;
        addMessage("user", text);
        chatInput.value = '';
        const typingId = showTyping();
        setTimeout(() => {
            removeTyping(typingId);
            addMessage("ai", "That looks interesting. Have you considered optimizing the loop?");
        }, 1500);
    }
    function addMessage(sender, text) {
        const div = document.createElement('div');
        div.className = `msg msg-${sender}`;
        div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function showTyping() {
        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.className = 'typing-indicator';
        div.id = id;
        div.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return id;
    }
    function removeTyping(id) {
        const el = document.getElementById(id);
        if(el) el.remove();
    }
</script>

</body>
</html>